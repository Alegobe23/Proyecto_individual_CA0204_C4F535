---
title: "Código del proyecto"
format: 
   html: 
     theme: cosmo
     self-contained: true
editor: visual
---

## Librerías

```{r}
library(dplyr)
library(readxl)
library(ggplot2)
library(lubridate)
```

## Tablas de datos

Primero, se filtra la tabla de datos de los Oscars de forma que únicamente se obtenga la información de las películas ganadoras de la categoría "Best Picture" (mejor película del año). Asimismo, se crea la variable que contiene la tabla de datos de la aplicación Letterboxd.

```{r}
#Se fija el directorio de trabajo. 
setwd("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535")

base.oscars.completa <- read.csv("data/the_oscar_award.csv")
base.oscars <- base.oscars.completa %>% 
  filter(canon_category == "BEST PICTURE",
         winner == "True")
View(base.oscars)

base.letterboxd <- read_excel("data/letterboxd_data.xlsx")
View(base.letterboxd)

```

## Funciones para desarrollar el proyecto

Ahora, se definen los rangos a partir de los cuales las calificaciones de Letterboxd se segmentarán en alto, medio y bajo. Para ello, se decidió utilizar la media y la desviación estándar, de manera que se clasifiquen como bajas todas aquellas calificaciones que estén por debajo de la resta de la media y la desviación estándar; como calificaciones medias se considerarán todas las que estén dentro del rango comprendido por la resta de la media y la desviación estándar, al igual que la suma de la media y la desviación estándar. Finalmente, se catalogarán como altas las calificaciones que estén por arriba de la suma de la media y la desviación estándar.

```{r}
#Se convierten las columnas correspondientes de la base de Letterboxd al tipo numérico. 
base.letterboxd$rating <- as.numeric(base.letterboxd$rating)
base.letterboxd$`watched by` <- as.numeric(base.letterboxd$`watched by`)

#Se realizan los cálculos correspondientes. 
promedio.calificaciones <- mean(base.letterboxd$rating, na.rm = T)
promedio.calificaciones
desviacion.calificaciones <- sd(base.letterboxd$rating)
desviacion.calificaciones
limite.bajo <- promedio.calificaciones - desviacion.calificaciones
limite.bajo
limite.alto <- promedio.calificaciones + desviacion.calificaciones
limite.alto

```

```{r}
#Se crea una función para clasificar las calificaciones. 
clasificar.calificaciones <- function(calificacion){
  ifelse(calificacion < limite.bajo, "Low",
         ifelse(calificacion > limite.alto, "High", "Medium"))
}

base.letterboxd <- base.letterboxd %>% 
  mutate(
    mean = promedio.calificaciones,
    standard.deviation = desviacion.calificaciones, 
    clasification.rating = clasificar.calificaciones(rating)
  )
View(base.letterboxd)

```

## Gráficos

Distribución de las calificaciones de las películas en Letterboxd

```{r}
ggplot(base.letterboxd, aes(x = rating))+
  geom_bar(color= "white", fill = "pink")+
  labs(x = "Calificación", y = "Cantidad", 
       title = "Distribución de las calificaciones en Letterboxd")+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(margin = margin(t = 15)),
        axis.title.y = element_text(margin = margin(r = 15)))+
  scale_y_continuous(breaks = seq(1, 20, 1))+
  scale_x_continuous(breaks = seq(0, 5, 0.1))+
  geom_text(stat = "count", aes(label = after_stat(count)), 
            vjust = 1, color = "deeppink", size = 3, fontface = "bold")

#Se guarda el gráfico en la carpeta de resultados. 
ggsave("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535/res/Distribucion_calificaciones_Letterboxd.png", width = 8, height = 6, dpi = 300)

```

Promedios de las calificaciones en Letterboxd ordenados según las décadas de las ceremonias

```{r}
ordenar.decadas <- base.letterboxd %>% 
  mutate(rating = as.numeric(rating),
         year = base.oscars$year_ceremony,
         decade = floor(year/10) * 10) %>% 
  group_by(decade) %>% 
  summarise(mean.rating = round(mean(rating, na.rm = T), 1))
#View(ordenar.decadas)

ggplot(ordenar.decadas, aes(x = decade, y = mean.rating)) +
  geom_line(color = "pink", linewidth = 1.5) +
  geom_point(color = "deeppink", size = 2.5) + 
  theme_minimal()+
  labs(x = "Décadas",
       y = "Promedio de las calificaciones",
       title = "Promedio de las calificaciones en Letterboxd por década")+
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(margin = margin(t = 15)),
        axis.title.y = element_text(margin = margin(r = 15)))+
  scale_x_continuous(breaks = seq(1920, 2020, 10))+
  scale_y_continuous(breaks = seq(3, 5, 0.1))

#Se guarda el gráfico en la carpeta de resultados. 
ggsave("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535/res/Promedio_calificaciones_Letterboxd_decada.png", width = 8, height = 6, dpi = 300)
```

Obras ganadoras al Óscar a Mejor Película según género

```{r}
ggplot(base.letterboxd, aes(x = genre)) +
  geom_bar(fill = "pink", width = 0.8)+
  theme_minimal()+
  labs(x = "Géneros", y = "Cantidad", 
       title = "Obras ganadoras al Óscar a Mejor Película según género")+
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 50, hjust = 1),
        axis.title.y = element_text(margin = margin(r = 15)))+
  scale_y_continuous(breaks = seq(0, 50, 5))+
  geom_text(stat = "count", aes(label = after_stat(count)), 
            vjust = -0.1, color = "deeppink", size = 3, fontface = "bold")
  

#Se guarda el gráfico en la carpeta de resultados. 
ggsave("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535/res/Ganadoras_oscar_genero.png", width = 8, height = 6, dpi = 300)
  
```

Clasificación de las calificaciones

```{r}
ggplot(base.letterboxd, aes(x = clasification.rating)) +
  geom_bar(fill = "pink", width = 0.5)+
  theme_minimal()+
  labs(x = "Clasificación", y = "Cantidad", 
       title = "Clasificación de las calificaciones")+
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(margin = margin(r = 15)),
        axis.title.x = element_text(margin = margin(t = 15)))+
  scale_y_continuous(breaks = seq(0, 90, 5))+
  geom_text(stat = "count", aes(label = after_stat(count)), 
            vjust = -0.1, color = "deeppink", size = 4, fontface = "bold") 

ggsave("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535/res/Clasificacion_calificaciones.png", width = 8, height = 6, dpi = 300)
```

Clasificación de las calificaciones: gráfico circular

```{r}
df.porcentaje <- base.letterboxd %>% 
  count(clasification.rating) %>% 
  mutate(porcentaje = (n/nrow(base.letterboxd)) * 100)

ggplot(df.porcentaje, aes(x = "", y= porcentaje, fill = clasification.rating)) +
  geom_bar(stat="identity", width= 0.5) +
  coord_polar("y", start=0) +
  theme_void() + 
  geom_text(aes(label = paste0(round(porcentaje,1), "%")),
            position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values = c("violet", "lightblue", "pink"), 
                    name = "Clasificaciones")+
  labs(title = "Distribución de las clasificaciones de las calificaciones en Letterboxd")+
  theme(plot.title = element_text(hjust = 0.5))

ggsave("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535/res/Clasificacion_calificaciones_circular.png", width = 8, height = 6, dpi = 300)
```

Clasificación de las calificaciones en Letterboxd según el género de las películas

```{r}
generos <- unique(base.letterboxd$genre)
  
for(i in generos){
  datos.utilizar = filter(base.letterboxd, genre == i)

  grafico = ggplot(datos.utilizar, aes(x = clasification.rating)) +
            geom_bar(fill = "pink", width = 0.3)+
            theme_minimal()+
            labs(x = "Clasificación", y = "Cantidad", 
                 title=paste("Clasificación de las calificaciones del género:",i))+
            theme(plot.title = element_text(hjust = 0.5),
                  axis.title.y = element_text(margin = margin(r = 15)),
                  axis.title.x = element_text(margin = margin(t = 15)))+
            geom_text(stat = "count", aes(label = after_stat(count)), 
                      vjust = 1, color = "deeppink", size = 4, fontface = "bold")

ggsave(paste0("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535/res/Clasificacion_calificaciones_", i, ".png"), plot = grafico, width = 8, height = 6, dpi = 300) }
```

Clasificación de las calificaciones en Letterboxd ordenado por décadas de ceremonias

```{r}
ordenar.decadas.2 <- base.letterboxd %>% 
  mutate(rating = as.numeric(rating),
         year = base.oscars$year_ceremony,
         decade = floor(year/10) * 10) %>% 
  group_by(decade) 

decadas <- unique(ordenar.decadas.2$decade)

for(i in decadas){
  datos.utilizar = filter(ordenar.decadas.2, decade == i)

  grafico = ggplot(datos.utilizar, aes(x = clasification.rating)) +
            geom_bar(fill = "pink", width = 0.3)+
            theme_minimal()+
            labs(x = "Clasificación", y = "Cantidad", 
                title=paste("Clasificación de las calificaciones de la década:",i))+
            theme(plot.title = element_text(hjust = 0.5),
                  axis.title.y = element_text(margin = margin(r = 15)),
                  axis.title.x = element_text(margin = margin(t = 15)))+
            geom_text(stat = "count", aes(label = after_stat(count)), 
                      vjust = 1, color = "deeppink", size = 4, fontface = "bold")
  
ggsave(paste0("C:/Users/alego/OneDrive/Documentos/Proyecto individual/Proyecto_individual_CA0204_C4F535/res/Clasificacion_calificaciones_", i, ".png"), plot = grafico, width = 8, height = 6, dpi = 300)}

```
